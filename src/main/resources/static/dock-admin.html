<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dock Config Admin</title>
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --accent: #38bdf8;
            --danger: #f87171;
            --success: #4ade80;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            min-height: 100vh;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        .layout {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 260px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 1rem;
        }
        .sidebar h2 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--muted);
            margin: 0 0 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .provider-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .provider-list li {
            margin-bottom: 0.25rem;
        }
        .provider-list button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 0.375rem;
            color: var(--text);
            cursor: pointer;
            font-size: 0.875rem;
        }
        .provider-list button:hover {
            background: rgba(56, 189, 248, 0.1);
            border-color: var(--border);
        }
        .provider-list button.active {
            background: rgba(56, 189, 248, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }
        .btn-new {
            margin-top: 0.75rem;
            width: 100%;
            padding: 0.5rem;
            background: var(--accent);
            color: var(--bg);
            border: none;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-new:hover {
            filter: brightness(1.1);
        }
        .main {
            flex: 1;
            padding: 1.5rem;
            overflow: auto;
        }
        .main h1 {
            font-size: 1.5rem;
            margin: 0 0 1.5rem;
        }
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        .card h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--muted);
            margin: 0 0 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .form-row:last-child { margin-bottom: 0; }
        label {
            display: block;
            font-size: 0.75rem;
            color: var(--muted);
            margin-bottom: 0.25rem;
        }
        input, select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            color: var(--text);
            font-size: 0.875rem;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }
        .buttons-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
        }
        .btn:hover {
            background: rgba(56, 189, 248, 0.1);
            border-color: var(--accent);
        }
        .btn-primary {
            background: var(--accent);
            color: var(--bg);
            border-color: var(--accent);
        }
        .btn-danger {
            background: transparent;
            color: var(--danger);
            border-color: var(--danger);
        }
        .btn-danger:hover {
            background: rgba(248, 113, 113, 0.1);
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .button-tree {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .button-tree .button-item {
            margin-bottom: 0.5rem;
        }
        .button-node {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
        }
        .button-node .type-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            background: var(--surface);
            color: var(--muted);
            text-transform: uppercase;
        }
        .button-node .type-badge.dropdown {
            background: rgba(56, 189, 248, 0.2);
            color: var(--accent);
        }
        .button-node .label {
            flex: 1;
            font-size: 0.875rem;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .button-node .actions {
            display: flex;
            gap: 0.25rem;
        }
        .button-children {
            list-style: none;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            border-left: 2px solid var(--border);
        }
        .empty-state {
            color: var(--muted);
            font-size: 0.875rem;
            padding: 1rem;
            text-align: center;
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }
        .modal-overlay.hidden { display: none; }
        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1.5rem;
            width: 100%;
            max-width: 420px;
        }
        .modal h3 {
            margin: 0 0 1rem;
            font-size: 1rem;
        }
        .modal .form-row { margin-bottom: 1rem; }
        .modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1.25rem;
        }
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            z-index: 101;
            animation: fadeIn 0.2s ease;
        }
        .toast.success { background: var(--success); color: var(--bg); }
        .toast.error { background: var(--danger); color: #fff; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .back-link {
            display: inline-block;
            color: var(--accent);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        .back-link:hover { text-decoration: underline; }
        .component-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }
        .component-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .component-row input {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <h2>Dock Configs</h2>
            <ul class="provider-list" id="providerList"></ul>
            <button type="button" class="btn-new" id="btnNew">+ New Dock Config</button>
        </aside>
        <main class="main">
            <a href="/" class="back-link">← Back to Welcome</a>
            <h1 id="pageTitle">Select or create a dock config</h1>
            <div id="editorPanel" style="display: none;">
                <div class="card">
                    <h3>Dock Config</h3>
                    <div class="form-row">
                        <div>
                            <label>ID</label>
                            <input type="text" id="configId" placeholder="e.g. CapitalMarketsDock" />
                        </div>
                        <div>
                            <label>Title</label>
                            <input type="text" id="configTitle" placeholder="Capital Markets Dock" />
                        </div>
                        <div>
                            <label>Icon URL</label>
                            <input type="text" id="configIcon" placeholder="home or https://..." />
                        </div>
                    </div>
                    <div class="form-row" style="margin-top: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="configDisableRearrangement" />
                            <label for="configDisableRearrangement" style="margin: 0;">Disable user rearrangement</label>
                        </div>
                    </div>
                    <div class="form-row" style="margin-top: 1rem;">
                        <div style="grid-column: 1 / -1;">
                            <label>Workspace components</label>
                            <div id="workspaceComponentsList" class="component-list"></div>
                            <button type="button" class="btn btn-sm" id="btnAddComponent" style="margin-top: 0.5rem;">+ Add component</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>Buttons</h3>
                    <div class="buttons-toolbar">
                        <button type="button" class="btn btn-primary" id="btnAddRoot">+ Add root button</button>
                        <button type="button" class="btn btn-primary" id="btnSave">Save all</button>
                    </div>
                    <ul class="button-tree" id="buttonTree"></ul>
                </div>
            </div>
            <div id="emptyState" class="empty-state">
                Select a dock config from the list or create a new one.
            </div>
        </main>
    </div>

    <div class="modal-overlay hidden" id="buttonModal">
        <div class="modal">
            <h3 id="modalTitle">Edit button</h3>
            <div class="form-row">
                <div style="grid-column: 1 / -1;">
                    <label>Type</label>
                    <select id="editType">
                        <option value="ActionButton">ActionButton</option>
                        <option value="DropdownButton">DropdownButton</option>
                    </select>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label>Tooltip</label>
                    <input type="text" id="editTooltip" placeholder="Sample Button 1" />
                </div>
                <div style="grid-column: 1 / -1;">
                    <label>Icon URL</label>
                    <input type="text" id="editIconUrl" placeholder="https://..." />
                </div>
                <div>
                    <label>Action ID</label>
                    <input type="text" id="editActionId" placeholder="sampleButton1" />
                </div>
                <div>
                    <label>Action customData</label>
                    <input type="text" id="editActionCustomData" placeholder="sampleButton1 clicked" />
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" id="modalCancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="modalSave">Save</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let providers = [];
        let currentProvider = null;
        let editingPath = null;

        const providerListEl = document.getElementById('providerList');
        const editorPanel = document.getElementById('editorPanel');
        const emptyState = document.getElementById('emptyState');
        const pageTitle = document.getElementById('pageTitle');
        const configId = document.getElementById('configId');
        const configTitle = document.getElementById('configTitle');
        const configIcon = document.getElementById('configIcon');
        const configDisableRearrangement = document.getElementById('configDisableRearrangement');
        const workspaceComponentsList = document.getElementById('workspaceComponentsList');
        const buttonTree = document.getElementById('buttonTree');
        const buttonModal = document.getElementById('buttonModal');
        const editType = document.getElementById('editType');
        const editTooltip = document.getElementById('editTooltip');
        const editIconUrl = document.getElementById('editIconUrl');
        const editActionId = document.getElementById('editActionId');
        const editActionCustomData = document.getElementById('editActionCustomData');

        async function loadProviders() {
            try {
                const res = await fetch(API_BASE + '/dockProvider');
                if (!res.ok) throw new Error('Failed to load providers');
                providers = await res.json();
                renderProviderList();
            } catch (e) {
                toast('Error loading providers: ' + e.message, 'error');
            }
        }

        function renderProviderList() {
            providerListEl.innerHTML = '';
            providers.forEach((p, i) => {
                const li = document.createElement('li');
                const btn = document.createElement('button');
                btn.textContent = (p.title || p.id || 'Untitled') + (p.id ? ` (${p.id})` : '');
                btn.dataset.index = i;
                if (currentProvider && currentProvider.id === p.id) btn.classList.add('active');
                btn.addEventListener('click', () => selectProvider(i));
                li.appendChild(btn);
                providerListEl.appendChild(li);
            });
        }

        function selectProvider(index) {
            if (index === -1) {
                currentProvider = { id: '', title: '', icon: '', workspaceComponents: [], disableUserRearrangement: false, buttons: [] };
                pageTitle.textContent = 'New Dock Config';
            } else {
                currentProvider = JSON.parse(JSON.stringify(providers[index]));
                pageTitle.textContent = 'Edit: ' + (currentProvider.title || currentProvider.id || 'Dock Config');
            }
            editorPanel.style.display = 'block';
            emptyState.style.display = 'none';
            configId.value = currentProvider.id || '';
            configTitle.value = currentProvider.title || '';
            configIcon.value = currentProvider.icon || '';
            configDisableRearrangement.checked = !!currentProvider.disableUserRearrangement;
            if (!Array.isArray(currentProvider.workspaceComponents)) currentProvider.workspaceComponents = [];
            renderWorkspaceComponents();
            renderButtonTree();
            renderProviderList();
        }

        function renderWorkspaceComponents() {
            const list = currentProvider && currentProvider.workspaceComponents || [];
            workspaceComponentsList.innerHTML = '';
            list.forEach((value, idx) => {
                const row = document.createElement('div');
                row.className = 'component-row';
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'e.g. home, notifications';
                input.value = value;
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-sm btn-danger';
                removeBtn.textContent = 'Remove';
                removeBtn.addEventListener('click', () => {
                    currentProvider.workspaceComponents.splice(idx, 1);
                    renderWorkspaceComponents();
                });
                row.appendChild(input);
                row.appendChild(removeBtn);
                workspaceComponentsList.appendChild(row);
            });
        }

        function addWorkspaceComponent() {
            if (!currentProvider) return;
            if (!currentProvider.workspaceComponents) currentProvider.workspaceComponents = [];
            currentProvider.workspaceComponents.push('');
            renderWorkspaceComponents();
        }

        /** Returns the list that contains the button at path (so list[path[path.length-1]] is the button). */
        function getListContainingButtonAtPath(path) {
            if (!path || path.length === 0 || !currentProvider.buttons) return currentProvider.buttons || [];
            if (path.length === 1) return currentProvider.buttons;
            let list = currentProvider.buttons;
            for (let i = 0; i < path.length - 1; i++) {
                const idx = path[i];
                if (list[idx] == null) return [];
                if (!list[idx].options) list[idx].options = [];
                list = list[idx].options;
            }
            return list;
        }

        /** Returns the options array of the button at path (so new children go inside that button's options). */
        function getOptionsOfButtonAtPath(path) {
            if (!path || path.length === 0 || !currentProvider.buttons) return null;
            let list = currentProvider.buttons;
            for (let i = 0; i < path.length; i++) {
                const idx = path[i];
                if (list[idx] == null) return null;
                if (i === path.length - 1) {
                    if (!list[idx].options) list[idx].options = [];
                    return list[idx].options;
                }
                list = list[idx].options || [];
            }
            return null;
        }

        function getButtonAtPath(path) {
            const list = getListContainingButtonAtPath(path);
            const idx = path && path.length ? path[path.length - 1] : -1;
            return list && list[idx] != null ? list[idx] : null;
        }

        function renderButtonTree(parentEl, buttons, pathPrefix = []) {
            parentEl = parentEl || buttonTree;
            const list = buttons !== undefined ? buttons : (currentProvider && currentProvider.buttons) || [];
            parentEl.innerHTML = '';

            list.forEach((btn, idx) => {
                const path = [...pathPrefix, idx];
                const li = document.createElement('li');
                li.className = 'button-item';
                const isDropdown = (btn.type === 'DropdownButton' || (btn.type && btn.type.toUpperCase && btn.type.toUpperCase() === 'DROPDOWNBUTTON'));
                const children = btn.options || [];

                li.innerHTML = `
                    <div class="button-node">
                        <span class="type-badge ${isDropdown ? 'dropdown' : ''}">${(btn.type || 'ActionButton')}</span>
                        <span class="label" title="${(btn.tooltip || '').replace(/"/g, '&quot;')}">${escapeHtml(btn.tooltip || '—')}</span>
                        <span class="actions">
                            <button type="button" class="btn btn-sm" data-action="edit" data-path="${path.join(',')}">Edit</button>
                            <button type="button" class="btn btn-sm" data-action="addChild" data-path="${path.join(',')}" ${!isDropdown ? 'disabled' : ''}>+ Child</button>
                            <button type="button" class="btn btn-sm btn-danger" data-action="delete" data-path="${path.join(',')}">Delete</button>
                        </span>
                    </div>
                `;
                const node = li.querySelector('.button-node');
                const childrenUl = document.createElement('ul');
                childrenUl.className = 'button-children';

                node.querySelector('[data-action="edit"]').addEventListener('click', () => openEditModal(path));
                node.querySelector('[data-action="addChild"]').addEventListener('click', () => addChild(path));
                node.querySelector('[data-action="delete"]').addEventListener('click', () => deleteButton(path));

                if (isDropdown && children.length > 0) {
                    renderButtonTree(childrenUl, children, path);
                    li.appendChild(childrenUl);
                } else if (isDropdown) {
                    li.appendChild(childrenUl);
                }

                parentEl.appendChild(li);
            });
        }

        function escapeHtml(s) {
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function openEditModal(path) {
            editingPath = path;
            const btn = getButtonAtPath(path);
            document.getElementById('modalTitle').textContent = 'Edit button';
            editType.value = (btn.type === 'DropdownButton' || (btn.type && btn.type.toUpperCase && btn.type.toUpperCase() === 'DROPDOWNBUTTON')) ? 'DropdownButton' : 'ActionButton';
            editTooltip.value = btn.tooltip || '';
            editIconUrl.value = btn.iconUrl || '';
            editActionId.value = (btn.action && btn.action.id) || '';
            editActionCustomData.value = (btn.action && btn.action.customData) || '';
            buttonModal.classList.remove('hidden');
        }

        function addChild(parentPath) {
            const list = getOptionsOfButtonAtPath(parentPath);
            if (!list) return;
            list.push({
                type: 'ActionButton',
                tooltip: 'New option',
                iconUrl: ''
            });
            renderButtonTree();
        }

        function addRootButton() {
            if (!currentProvider) return;
            if (!currentProvider.buttons) currentProvider.buttons = [];
            currentProvider.buttons.push({
                type: 'ActionButton',
                tooltip: 'New button',
                iconUrl: ''
            });
            renderButtonTree();
        }

        function deleteButton(path) {
            if (!path || path.length === 0) return;
            const list = getListContainingButtonAtPath(path);
            const idx = path[path.length - 1];
            if (list && list[idx] != null) list.splice(idx, 1);
            renderButtonTree();
        }

        function closeModal() {
            buttonModal.classList.add('hidden');
            editingPath = null;
        }

        function saveButtonFromModal() {
            if (editingPath == null) return;
            const btn = getButtonAtPath(editingPath);
            const typeVal = editType.value;
            btn.type = typeVal;
            btn.tooltip = editTooltip.value.trim() || '';
            btn.iconUrl = editIconUrl.value.trim() || '';
            if (typeVal === 'ActionButton') {
                const aid = editActionId.value.trim();
                const acd = editActionCustomData.value.trim();
                if (aid || acd) {
                    btn.action = { id: aid, customData: acd };
                } else {
                    delete btn.action;
                }
                delete btn.options;
            } else {
                if (!btn.options) btn.options = [];
                delete btn.action;
            }
            closeModal();
            renderButtonTree();
        }

        function syncConfigFromForm() {
            if (!currentProvider) return;
            currentProvider.id = configId.value.trim();
            currentProvider.title = configTitle.value.trim();
            currentProvider.icon = configIcon.value.trim();
            currentProvider.disableUserRearrangement = configDisableRearrangement.checked;
            const inputs = workspaceComponentsList.querySelectorAll('.component-row input');
            currentProvider.workspaceComponents = Array.from(inputs).map(i => i.value.trim()).filter(Boolean);
        }

        async function saveAll() {
            syncConfigFromForm();
            if (!currentProvider.id) {
                toast('Please set Dock Config ID', 'error');
                return;
            }
            const payload = {
                id: currentProvider.id,
                title: currentProvider.title,
                icon: currentProvider.icon,
                workspaceComponents: currentProvider.workspaceComponents || [],
                disableUserRearrangement: !!currentProvider.disableUserRearrangement,
                buttons: currentProvider.buttons || []
            };
            try {
                const res = await fetch(API_BASE + '/dockProvider', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    const err = await res.text();
                    throw new Error(err || res.statusText);
                }
                const saved = await res.json();
                providers = providers.filter(p => p.id !== saved.id);
                providers.push(saved);
                currentProvider = saved;
                configId.value = saved.id || '';
                configTitle.value = saved.title || '';
                configIcon.value = saved.icon || '';
                configDisableRearrangement.checked = !!saved.disableUserRearrangement;
                if (!Array.isArray(saved.workspaceComponents)) saved.workspaceComponents = [];
                currentProvider.workspaceComponents = saved.workspaceComponents;
                renderWorkspaceComponents();
                renderProviderList();
                renderButtonTree();
                toast('Saved successfully');
            } catch (e) {
                toast('Save failed: ' + e.message, 'error');
            }
        }

        function toast(message, type = 'success') {
            const el = document.createElement('div');
            el.className = 'toast ' + type;
            el.textContent = message;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        document.getElementById('btnNew').addEventListener('click', () => selectProvider(-1));
        document.getElementById('btnAddComponent').addEventListener('click', addWorkspaceComponent);
        document.getElementById('btnAddRoot').addEventListener('click', addRootButton);
        document.getElementById('btnSave').addEventListener('click', saveAll);
        document.getElementById('modalCancel').addEventListener('click', closeModal);
        document.getElementById('modalSave').addEventListener('click', saveButtonFromModal);

        loadProviders();
    </script>
</body>
</html>
